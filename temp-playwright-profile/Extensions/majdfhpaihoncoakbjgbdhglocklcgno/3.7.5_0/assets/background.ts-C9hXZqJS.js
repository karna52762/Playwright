import{b as r,m as _,S as W}from"./index-BwDjUviV.js";import{E as re,a as g,g as p,u as S,b as R,e as D,o as v,s as m,S as d,c as U,A as q,d as I,f as G,n as A,r as oe,h as ce,i as j,j as V,_ as L}from"./index-BJq-9179.js";import{a as N,b as C,n as f,i as P,c as F,d as K,w as Z,e as J,p as $,f as w}from"./index-BJQOGo5M.js";import{U as H}from"./ua-parser-CvpKYoEI.js";import{l as X,c as Y,a as le,b as ue,d as pe,e as he}from"./index-Bx0ZAMk7.js";import{i as Q}from"./index-DSaojuSY.js";import"./i18next-Lgj2Bm8L.js";function de(i){return/https?:\/\/(?:www\.)?([-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b)*(\/[\/\d\w\.-]*)*(?:[\?])*(.+)*/gi.test(i)}class z{constructor(e,t,n,s,a,o,c,l,u,x,B,k,ne,ie,ae){this.analyticsService=e,this.accessService=t,this.appService=n,this.notificationService=s,this.i18nService=a,this.globalStateService=o,this.apiFreeService=c,this.apiPremiumService=l,this.userService=u,this.webrtcService=x,this.exclusionsService=B,this.abTestsService=k,this.eventService=ne,this.proxyService=ie,this.connectionService=ae}async uninstallSelf(){return await Promise.resolve(this),await r.management.uninstallSelf(),{success:!0,data:{success:!0}}}async refreshSelf(){await this.proxyService.disable();const e=this.eventService.dispatch({reset:void 0});return await Promise.all(e),r.runtime.reload(),{success:!0,data:{success:!0}}}async getAnalyticPrivacy(){return await Promise.resolve(),{success:!0,data:{show:this.analyticsService.needPrivacyAcceptance}}}async setAnalyticPrivacy(e){return await this.analyticsService.setPrivacy(e),await this.accessService.setUninstallURL(),(await r.tabs.query({})).filter(s=>s.url?.includes("src/pages/consent-settings/index.html")).forEach(s=>{s?.id&&r.tabs.remove(s.id).catch(()=>{})}),await this.accessService.proceedToWebsitePage({page:"install",params:{utm_campaign:"welcome"}}),{success:!0,data:{success:!0}}}async sendAnalyticEvent(e){return await Promise.resolve(),this.analyticsService.sendEvent(e),{success:!0,data:{success:!0}}}async showWebsitePage(e){return await this.accessService.proceedToWebsitePage(e),{success:!0,data:{success:!0}}}async setColorTheme(e){return await this.appService.setColorTheme(e),{success:!0,data:{success:!0}}}async getAppData(){return await Promise.resolve(),{success:!0,data:{version:this.appService.version,theme:this.appService.colorTheme}}}async getShowOnboarding(){return await Promise.resolve(),{success:!0,data:{show:this.appService.showOnboarding}}}async closeOnboarding(){return await this.appService.setShowOnboarding(!1),{success:!0,data:{success:!0}}}async setActiveLocale(e){return await this.i18nService.setLocale(e),{success:!0,data:{success:!0}}}async getActiveLocale(){return await Promise.resolve(),{success:!0,data:{locale:this.i18nService.activeLocale}}}async getLanguageList(){return await Promise.resolve(),{success:!0,data:{list:this.i18nService.languageList}}}async getNotificationPermition(){return await Promise.resolve(),{success:!0,data:{permition:this.notificationService.permition}}}async setNotificationPermition(e){return await this.notificationService.setNotificationPermition(e),{success:!0,data:{success:!0}}}async getSessionCount(){return await Promise.resolve(),{success:!0,data:{count:this.appService.sessionCount}}}async incrementSessionCount(){return await this.appService.incrementSessionCount(),{success:!0,data:{count:this.appService.sessionCount}}}async getDownloadLink(e){return{success:!0,data:{link:await this.appService.getDownloadLink(e)}}}async getBlockAds(){return await Promise.resolve(),{success:!0,data:{status:this.appService.isBlockAds}}}async setBlockAds(e){return await this.appService.setBlockAds(e.status),{success:!0,data:{success:!0}}}async setDeviceScreenData(e){return await this.globalStateService.setDeviceScreenData(e),{success:!0,data:{success:!0}}}async getRateUsData(){return await Promise.resolve(),{success:!0,data:this.appService.rateUsData}}async incrementRateUsData(){return await this.appService.incrementRateUs(),{success:!0,data:{success:!0}}}async showExtensionStore(){const t={platform:"chrome"},n=this.userService.hasPermitions("domain","premium")?await this.apiPremiumService.fetch({method:"POST",url:"apiUrlReview",body:t}):await this.apiFreeService.fetch({method:"POST",url:"apiUrlReview",body:t}),s=n.success?n.data.url:this.appService.extensionStoreUrl;return await r.tabs.create({url:s}),{success:!0,data:{success:!0}}}async getBlockWebrtc(){return await Promise.resolve(),{success:!0,data:{status:this.webrtcService.isApplied}}}async enableBlockWebrtc(){const e=await this.webrtcService.enable();return e.status?(await this.webrtcService.setBlockWebrtc(!0),{success:!0,data:{success:!0}}):{success:!1,errors:[{code:0,status:0,name:"",message:e.cause==="not_controllable"?this.i18nService.t("base:webrtc-errors.not-controllable"):this.i18nService.t("base:webrtc-errors.controlled-by-other-extensions")}]}}async disableBlockWebrtc(){return await this.webrtcService.disable()?(await this.webrtcService.setBlockWebrtc(!1),{success:!0,data:{success:!0}}):{success:!1,errors:[{code:0,status:0,name:"",message:this.i18nService.t("base:webrtc-errors.remove-webrtc")}]}}async getActiveTabInfo(){await Promise.resolve(this);const t=(await r.tabs.query({currentWindow:!0,active:!0})).at(0);if(!t||!t.url)return{success:!0,data:{info:null}};if(!de(t.url))return{success:!0,data:{info:null}};const{hostname:s}=new URL(t.url);return{success:!0,data:{info:{matchPattern:s,favicon:t.favIconUrl}}}}async getExclusionSites(){return await Promise.resolve(),{success:!0,data:{list:this.exclusionsService.exclusionSites}}}async addExclusionSite(e){return await this.exclusionsService.add(e),{success:!0,data:{success:!0}}}async removeExclusionSite(e){return await this.exclusionsService.remove(e),{success:!0,data:{success:!0}}}async closeConnectionSurvey(){return await this.appService.closeConnectionSurvey(),{success:!0,data:{success:!0}}}async incrementConnectionSurvey(){return await this.appService.incrementConnectionSurvey(),{success:!0,data:{success:!0}}}async delayConnectionSurvey(){return await this.appService.delayConnectionSurvey(),{success:!0,data:{success:!0}}}async disableConnectionSurvey(){return await this.appService.disableConnectionSurvey(),{success:!0,data:{success:!0}}}async getConnectionSurvey(){return await Promise.resolve(),{success:!0,data:{close:this.appService.connectionSurveyClose,needShow:this.appService.needShowConnectionSurvey}}}async getDiscountBanner(){return await Promise.resolve(),{success:!0,data:{active:this.abTestsService.getExperimentStatus(re.discount60off).active}}}async getBanner2Session(){await Promise.resolve();const{banner2Session:e,sessionCount:t}=this.appService,n=e.active&&t>2;if(n){const s=await this.getBanner3Connection();s.success&&s.data.active&&await this.disableBanner3Connection();const a=await this.getBanner15Connection();a.success&&a.data.active&&await this.disableBanner15Connection()}return{success:!0,data:{active:n}}}async disableBanner2Session(){return await this.appService.disableBanner2Session(),{success:!0,data:{success:!0}}}async getBanner3Connection(){await Promise.resolve();const{banner3Connection:e}=this.appService,n=this.connectionService.connectionCount===3;return{success:!0,data:{active:e.active&&n}}}async disableBanner3Connection(){return await this.appService.disableBanner3Connection(),{success:!0,data:{success:!0}}}async getBanner15Connection(){await Promise.resolve();const{banner15Connection:e}=this.appService,n=this.connectionService.connectionCount===15;return{success:!0,data:{active:e.active&&n}}}async disableBanner15Connection(){return await this.appService.disableBanner15Connection(),{success:!0,data:{success:!0}}}async getBanner14Days(){await Promise.resolve(),this.appService.banner14Days.nextTimestamp<Date.now()&&await this.appService.activateBanner14Days();const{banner14Days:t}=this.appService,n=t.active;if(n){const s=await this.getBanner2Session();s.success&&s.data.active&&await this.disableBanner2Session();const a=await this.getBanner3Connection();a.success&&a.data.active&&await this.disableBanner3Connection();const o=await this.getBanner15Connection();o.success&&o.data.active&&await this.disableBanner15Connection()}return{success:!0,data:{active:n}}}async disableBanner14Days(){return await this.appService.disableBanner14Days(),{success:!0,data:{success:!0}}}async getBanner16Days(){await Promise.resolve();const e=this.globalStateService.geolocation?.country,t=e!=="ir"&&e!=="ru",{banner16Days:n}=this.appService,s=n.nextTimestamp<Date.now(),a=t&&n.active&&s;if(a){const o=await this.getBanner2Session();o.success&&o.data.active&&await this.disableBanner2Session();const c=await this.getBanner3Connection();c.success&&c.data.active&&await this.disableBanner3Connection();const l=await this.getBanner15Connection();l.success&&l.data.active&&await this.disableBanner15Connection();const u=await this.getBanner14Days();u.success&&u.data.active&&await this.disableBanner14Days()}return{success:!0,data:{active:a}}}async disableBanner16Days(){return await this.appService.disableBanner16Days(),{success:!0,data:{success:!0}}}static async getActiveExtensionsWithProxyPermition(){return(await r.management.getAll()).filter(s=>s.type==="extension"&&s.id!==r.runtime.id).filter(s=>{const a=s.enabled,o=s.permissions?.includes("proxy");return a&&o})}async getProxyControlStatus(){const e=await r.tabs.query({active:!0,currentWindow:!0}).then(a=>a.at(0)?.url),n=["chrome://extensions","about:addons","edge://extensions","opera://extensions"].some(a=>e?.includes(a));return{success:!0,data:{blocked:!(await this.proxyService.getControlProxyStatus()).status,"extensions-tab":n}}}async openExtensionsTab(){await Promise.resolve(this);const n={chrome:"chrome://extensions",firefox:"about:addons",edge:"edge://extensions",opera:"opera://extensions"}["chrome"];return await r.tabs.create({url:n}),{success:!0,data:{success:!0}}}async disableProxyControlExtensions(){await Promise.resolve(this);const e=await z.getActiveExtensionsWithProxyPermition();return await Promise.all(e.map(t=>r.management.setEnabled(t.id,!1))),{success:!0,data:{success:!0}}}}class ge{constructor(e,t){this.messageService=e,this.appController=t}init(){this.messageService.subscribe({"uninstall-self":this.uninstallSelf.bind(this),"refresh-self":this.refreshSelf.bind(this),"hold-active-ping":this.holdActivePing.bind(this),"send-analytic-event":this.sendAnalyticEvent.bind(this),"get-analytic-privacy":this.getAnalyticPrivacy.bind(this),"set-analytic-privacy":this.setAnalyticPrivacy.bind(this),"show-website-page":this.showWebsitePage.bind(this),"set-color-theme":this.setColorTheme.bind(this),"get-app-data":this.getAppData.bind(this),"get-show-onboarding":this.getShowOnboarding.bind(this),"close-onboarding":this.closeOnboarding.bind(this),"set-active-locale":this.setActiveLocale.bind(this),"get-active-locale":this.getActiveLocale.bind(this),"get-language-list":this.getLanguageList.bind(this),"set-notification-permition":this.setNotificationPermition.bind(this),"get-notification-permition":this.getNotificationPermition.bind(this),"get-session-count":this.getSessionCount.bind(this),"increment-session-count":this.incrementSessionCount.bind(this),"get-download-link":this.getDownloadLink.bind(this),"get-block-ads":this.getBlockAds.bind(this),"set-block-ads":this.setBlockAds.bind(this),"set-device-screen":this.setDeviceScreenData.bind(this),"get-rate-us":this.getRateUsData.bind(this),"increment-rate-us":this.incrementRateUsData.bind(this),"show-extension-store":this.showExtensionStore.bind(this),"get-block-webrtc":this.getBlockWebrtc.bind(this),"enable-block-webrtc":this.enableBlockWebrtc.bind(this),"disable-block-webrtc":this.disableBlockWebrtc.bind(this),"get-active-tab-info":this.getActiveTabInfo.bind(this),"get-exclusion-sites":this.getExclusionSites.bind(this),"add-exclusion-site":this.addExclusionSite.bind(this),"remove-exclusion-site":this.removeExclusionSite.bind(this),"close-connection-survey":this.closeConnectionSurvey.bind(this),"increment-connection-survey":this.incrementConnectionSurvey.bind(this),"delay-connection-survey":this.delayConnectionSurvey.bind(this),"disable-connection-survey":this.disableConnectionSurvey.bind(this),"get-connection-survey":this.getConnectionSurvey.bind(this),"get-discount-banner-state":this.getDiscountBanner.bind(this),"get-banner-2-session":this.getBanner2Session.bind(this),"disable-banner-2-session":this.disableBanner2Session.bind(this),"get-banner-3-connection":this.getBanner3Connection.bind(this),"disable-banner-3-connection":this.disableBanner3Connection.bind(this),"get-banner-15-connection":this.getBanner15Connection.bind(this),"disable-banner-15-connection":this.disableBanner15Connection.bind(this),"get-banner-14-days":this.getBanner14Days.bind(this),"disable-banner-14-days":this.disableBanner14Days.bind(this),"get-banner-16-days":this.getBanner16Days.bind(this),"disable-banner-16-days":this.disableBanner16Days.bind(this),"get-proxy-control-status":this.getProxyControlStatus.bind(this),"open-extensions-tab":this.openExtensionsTab.bind(this),"disable-proxy-control-extensions":this.disableProxyControlExtensions.bind(this)})}async uninstallSelf(){return{...await this.appController.uninstallSelf(),type:"uninstall-self"}}async refreshSelf(){return{...await this.appController.refreshSelf(),type:"refresh-self"}}async holdActivePing(){return await Promise.resolve(this),{type:"hold-active-ping",success:!0,data:{success:!0}}}async setAnalyticPrivacy(e){return{...await this.appController.setAnalyticPrivacy(e),type:"set-analytic-privacy"}}async getAnalyticPrivacy(){return{...await this.appController.getAnalyticPrivacy(),type:"get-analytic-privacy"}}async sendAnalyticEvent(e){return{...await this.appController.sendAnalyticEvent(e),type:"send-analytic-event"}}async showWebsitePage(e){return{...await this.appController.showWebsitePage(e),type:"show-website-page"}}async setColorTheme(e){return{...await this.appController.setColorTheme(e),type:"set-color-theme"}}async getAppData(){return{...await this.appController.getAppData(),type:"get-app-data"}}async getShowOnboarding(){return{...await this.appController.getShowOnboarding(),type:"get-show-onboarding"}}async closeOnboarding(){return{...await this.appController.closeOnboarding(),type:"close-onboarding"}}async setActiveLocale(e){return{...await this.appController.setActiveLocale(e),type:"set-active-locale"}}async getActiveLocale(){return{...await this.appController.getActiveLocale(),type:"get-active-locale"}}async getLanguageList(){return{...await this.appController.getLanguageList(),type:"get-language-list"}}async setNotificationPermition(e){return{...await this.appController.setNotificationPermition(e),type:"set-notification-permition"}}async getNotificationPermition(){return{...await this.appController.getNotificationPermition(),type:"get-notification-permition"}}async getSessionCount(){return{...await this.appController.getSessionCount(),type:"get-session-count"}}async incrementSessionCount(){return{...await this.appController.incrementSessionCount(),type:"increment-session-count"}}async getDownloadLink(e){return{...await this.appController.getDownloadLink(e),type:"get-download-link"}}async getBlockAds(){return{...await this.appController.getBlockAds(),type:"get-block-ads"}}async setBlockAds(e){return{...await this.appController.setBlockAds(e),type:"set-block-ads"}}async setDeviceScreenData(e){return{...await this.appController.setDeviceScreenData(e),type:"set-device-screen"}}async getRateUsData(){return{...await this.appController.getRateUsData(),type:"get-rate-us"}}async incrementRateUsData(){return{...await this.appController.incrementRateUsData(),type:"increment-rate-us"}}async showExtensionStore(){return{...await this.appController.showExtensionStore(),type:"show-extension-store"}}async getBlockWebrtc(){return{...await this.appController.getBlockWebrtc(),type:"get-block-webrtc"}}async enableBlockWebrtc(){return{...await this.appController.enableBlockWebrtc(),type:"enable-block-webrtc"}}async disableBlockWebrtc(){return{...await this.appController.disableBlockWebrtc(),type:"disable-block-webrtc"}}async getActiveTabInfo(){return{...await this.appController.getActiveTabInfo(),type:"get-active-tab-info"}}async getExclusionSites(){return{...await this.appController.getExclusionSites(),type:"get-exclusion-sites"}}async addExclusionSite(e){return{...await this.appController.addExclusionSite(e),type:"add-exclusion-site"}}async removeExclusionSite(e){return{...await this.appController.removeExclusionSite(e),type:"remove-exclusion-site"}}async closeConnectionSurvey(){return{...await this.appController.closeConnectionSurvey(),type:"close-connection-survey"}}async incrementConnectionSurvey(){return{...await this.appController.incrementConnectionSurvey(),type:"increment-connection-survey"}}async delayConnectionSurvey(){return{...await this.appController.delayConnectionSurvey(),type:"delay-connection-survey"}}async disableConnectionSurvey(){return{...await this.appController.disableConnectionSurvey(),type:"disable-connection-survey"}}async getConnectionSurvey(){return{...await this.appController.getConnectionSurvey(),type:"get-connection-survey"}}async getDiscountBanner(){return{...await this.appController.getDiscountBanner(),type:"get-discount-banner-state"}}async getBanner2Session(){return{...await this.appController.getBanner2Session(),type:"get-banner-2-session"}}async disableBanner2Session(){return{...await this.appController.disableBanner2Session(),type:"disable-banner-2-session"}}async getBanner3Connection(){return{...await this.appController.getBanner3Connection(),type:"get-banner-3-connection"}}async disableBanner3Connection(){return{...await this.appController.disableBanner3Connection(),type:"disable-banner-3-connection"}}async getBanner15Connection(){return{...await this.appController.getBanner15Connection(),type:"get-banner-15-connection"}}async disableBanner15Connection(){return{...await this.appController.disableBanner15Connection(),type:"disable-banner-15-connection"}}async getBanner14Days(){return{...await this.appController.getBanner14Days(),type:"get-banner-14-days"}}async disableBanner14Days(){return{...await this.appController.disableBanner14Days(),type:"disable-banner-14-days"}}async getBanner16Days(){return{...await this.appController.getBanner16Days(),type:"get-banner-16-days"}}async disableBanner16Days(){return{...await this.appController.disableBanner16Days(),type:"disable-banner-16-days"}}async getProxyControlStatus(){return{...await this.appController.getProxyControlStatus(),type:"get-proxy-control-status"}}async openExtensionsTab(){return{...await this.appController.openExtensionsTab(),type:"open-extensions-tab"}}async disableProxyControlExtensions(){return{...await this.appController.disableProxyControlExtensions(),type:"disable-proxy-control-extensions"}}}const ve=new z(g,N,C,f,P,p,F,K,S,Z,J,R,D,$,w),Se=new ge(_,ve);class ye{constructor(e){this.introOfferService=e}async getIntroOfferData(){return await Promise.resolve(),{success:!0,data:this.introOfferService.data}}async getIntroOfferBanner(){return await Promise.resolve(),{success:!0,data:this.introOfferService.banner}}async closeIntroOfferBanner(){return await this.introOfferService.deactivateBanner(),{success:!0,data:{success:!0}}}}let be=class{constructor(e,t){this.messageService=e,this.introOfferController=t}init(){this.messageService.subscribe({"get-intro-offer-data":this.getIntroOfferData.bind(this),"get-intro-offer-banner":this.getIntroOfferBanner.bind(this),"close-intro-offer-banner":this.closeIntroOfferBanner.bind(this)})}async getIntroOfferData(){return{...await this.introOfferController.getIntroOfferData(),type:"get-intro-offer-data"}}async getIntroOfferBanner(){return{...await this.introOfferController.getIntroOfferBanner(),type:"get-intro-offer-banner"}}async closeIntroOfferBanner(){return{...await this.introOfferController.closeIntroOfferBanner(),type:"close-intro-offer-banner"}}};const me=new ye(Q),fe=new be(_,me);function we(i){return typeof i=="object"&&i!==null&&"type"in i&&typeof i.type=="string"}class _e extends W{messageMap=new Map;edpPort=null;constructor(){super(),r.runtime.onConnectExternal.addListener(this.longLivedMessageHandler.bind(this))}async boot(){this.bootResolve(),await this.bootPromise}longLivedMessageHandler(e){this.edpPort=e,e.onMessage.addListener(t=>{if(we(t)){const n=this.messageMap.get(t.type);n&&this.bootPromise.then(()=>n(t.data)).then(s=>{e.postMessage({id:t.id,...s})}).catch(()=>{})}}),e.onDisconnect.addListener(()=>{this.edpPort=null})}subscribe(e){Object.entries(e).forEach(([n,s])=>{if(this.messageMap.has(n))throw Error(`MessageService: subscribe already has ${n} handler`);this.messageMap.set(n,s)})}notifyEdp(e){try{this.edpPort?.postMessage(e)}catch{}}}const M=new _e,Ce=v({sessionId:m().optional().describe(d.session)}).default({}),Pe=new U(Ce),xe="https://www.google-analytics.com/mp/collect",Be="G-JY9WLXGNHW",ke="cECyLU2hSiaL1TVJULha8Q",E=H(navigator.userAgent);class Te extends q{constructor(e,t,n,s,a,o,c,l,u,x,B){super(e),this.analyticsStorage=t,this.analyticsService=n,this.globalStateService=s,this.fetchService=a,this.userService=o,this.appService=c,this.notificationService=l,this.i18nService=u,this.connectionService=x,this.edpMessageService=B;const k=new URL(xe);k.searchParams.set("measurement_id",Be),k.searchParams.set("api_secret",ke),this.GA_URL=k.href,this.analyticsService.use(this)}GA_URL;async boot(){await this.analyticsStorage.sync(),this.analyticsStorage.state.sessionId||await this.updateSessionId(),this.bootResolve()}async send(e){if(await this.bootPromise,!this.available)return;const t=this.formatData(e);this.edpMessageService.notifyEdp({type:"edp-ga-analytic-event",success:!0,data:t}),await this.fetchService.request({url:this.GA_URL,method:"POST",body:t})}formatData(e){const t=this.globalStateService.udid.value,n=this.getUserProperties(),s={name:e.name,params:{session_id:this.analyticsStorage.state.sessionId??"",screen_name:"main",engagement_time_msec:100,...e.data??{}}};return{client_id:t,user_properties:n,events:[s]}}getUserProperties(){const e=r.runtime.getManifest(),t=this.globalStateService.udid.value,n=this.globalStateService.geolocation?.country??"n/a",s=this.userService.subscription?.name??"free",a=this.notificationService.permition==="allowed"?"on":"off",o=()=>this.appService.colorTheme==="dark"?"on":this.appService.colorTheme==="light"?"off":"default";return{user_type:{value:this.userService.userType},plan:{value:s},udid:{value:t},version:{value:e.version},platform:{value:"chrome_extension"},user_country:{value:n},desktop_notifications:{value:a},dark_mode:{value:o()},language:{value:this.i18nService.activeLocale},auto_connect:{value:this.connectionService.useAutoConnect},browser:{value:E.browser.name??"n/a"},browser_version:{value:E.browser.version??"n/a"},os:{value:E.os.name??"n/a"},os_version:{value:E.os.version??"n/a"}}}async updateSessionId(){await this.analyticsStorage.setItems({sessionId:crypto.randomUUID()})}}const Ae=new I("google-analytics",Pe,D),h=new Te("google-analytics",Ae,g,p,G,S,C,f,P,w,M),De="https://oovttlsctrmbll4c3pxzbi55na0vbuln.lambda-url.us-west-2.on.aws/",Ee=10,Le=v({id:m(),startedAt:A()}),Oe=oe(m(),ce([m(),A(),j()])),Re=v({startAppVersion:m().describe(d.persist),sessionSequenceNumber:A().describe(d.persist),sessionData:Le.optional().describe(d.session),eventSequenceNumber:A().describe(d.persist),eventsBuffer:V(Oe).describe(d.persist)}).default({startAppVersion:r.runtime.getManifest().version,sessionSequenceNumber:0,eventSequenceNumber:0,eventsBuffer:[]}),Ue=new U(Re),T=H(navigator.userAgent);class Ie extends q{constructor(e,t,n,s,a,o,c,l,u,x,B){super(e),this.analyticsStorage=t,this.analyticsService=n,this.globalStateService=s,this.userService=a,this.i18nService=o,this.fetchService=c,this.appService=l,this.connectionService=u,this.notificationService=x,this.edpMessageService=B,this.analyticsService.use(this)}saveEventPromise=Promise.resolve();get eventNumber(){return this.analyticsStorage.state.eventSequenceNumber}async boot(){await this.analyticsStorage.sync(),this.analyticsStorage.state.sessionData||(await this.incrementSessionSequenceNumber(),await this.generateSessionData()),this.bootResolve()}async send(e){if(await this.bootPromise,!this.available)return;await this.saveEventPromise,await this.incrementEventSequenceNumber();const t={...e,data:{...e.data,event_id:this.eventNumber,event_time_utc:Date.now()}},n=this.formatData(t);await this.addEventToBuffer(n);const{eventsBuffer:s}=await this.analyticsStorage.getItems("eventsBuffer");s.length>=Ee&&(await this.clearEventsBuffer(),this.saveEventPromise=this.fetchService.request({url:De,method:"POST",body:s}))}formatData(e){const t=this.getUserProperties(),n=this.getGeneralProperties(),s={...t,...n,...e.data,event_name:e.name};return this.edpMessageService.notifyEdp({type:"edp-kinesis-analytic-event",success:!0,data:s}),s}getUserProperties(){const e=this.connectionService.useAutoConnect?"on":"off",t=this.appService.isBlockAds?"on":"off",n=this.notificationService.permition==="allowed"?"on":"off",s={user_properties__autoconnect_app:e,user_properties__adblock:t,user_properties__webrtc:"default",user_properties__stop_trackers:"default",user_properties__block_traking_socials:"default",user_properties__block_push_cookies:"default",user_properties__malware_evader:"default",user_properties__remove_utm_parameters:"default",user_properties__remove_fbclid:"default",user_properties__remove_gclid:"default",user_properties__location_warp:"default",user_properties__time_warp:"default",user_properties__language_warp:"default",user_properties__plan:"default",user_properties__desktop_notifications:n,user_properties__smart_location:"default",user_properties__exclude_websites:"default",user_properties__custom_proxy:"default",user_properties__mask_user_agent:"default",user_properties__debug_logging:"default"};return this.userService.subscription&&(s.user_properties__plan=this.userService.subscription.name),s}getGeneralProperties(){const e=r.runtime.getManifest(),t=new Date().toString().match(/([-+][0-9]+)\s/)?.[1]??"",{timeZone:n}=Intl.DateTimeFormat().resolvedOptions(),s=this.analyticsStorage.state.sessionSequenceNumber===1?1:0,a=T.browser.name??"Chrome",o=T.browser.version??"0.0.0",c=()=>this.appService.colorTheme==="dark"?"dark":this.appService.colorTheme==="light"?"light":"default";return{user_id:this.userService.user?.id??"",device_id:this.globalStateService.udid.value,time_offset:t,time_zone:n,session_number:this.analyticsStorage.state.sessionSequenceNumber,session_id:this.analyticsStorage.state.sessionData?.id??"",session_started:this.analyticsStorage.state.sessionData?.startedAt??"",is_first_session:s,app_version:e.version,start_app_version:this.analyticsStorage.state.startAppVersion,platform:"extension",device_category:T.device.type??"desktop",os_name:T.os.name??"",os_version:T.os.version??"",screen_width:String(this.globalStateService.deviceScreen.width),screen_height:String(this.globalStateService.deviceScreen.height),browser_group:a,browser_name:`${a} ${o}`,browser_user_agent:navigator.userAgent,app_language:this.i18nService.activeLocale,ip_address:this.globalStateService.geolocation?.initialIpAddress??"",country:this.globalStateService.geolocation?.country??"",region:this.globalStateService.geolocation?.region??"",event_source:"extension",user_properties__exp_id:this.analyticsService.experiment?.slug??"",user_properties__exp_var:this.analyticsService.experiment?.group.toString()??"",user_properties__install_date:this.globalStateService.installedAt,user_properties__theme:c()}}async incrementEventSequenceNumber(){await this.analyticsStorage.setItems({eventSequenceNumber:this.eventNumber+1})}async incrementSessionSequenceNumber(){const e=this.analyticsStorage.state.sessionSequenceNumber;await this.analyticsStorage.setItems({sessionSequenceNumber:e+1})}async generateSessionData(){await this.analyticsStorage.setItems({sessionData:{id:crypto.randomUUID(),startedAt:Date.now()}})}async addEventToBuffer(e){const{eventsBuffer:t}=await this.analyticsStorage.getItems("eventsBuffer");await this.analyticsStorage.setItems({eventsBuffer:[...t,e]})}async clearEventsBuffer(){await this.analyticsStorage.setItems({eventsBuffer:[]})}}const Ne=new I("aws-kinesis",Ue,D),Me=new Ie("aws-kinesis",Ne,g,p,S,P,G,C,w,f,M),We="349c341094927d0c67a38a15e4cfbfdc",qe="https://api2.amplitude.com/2/httpapi";class Ge extends q{constructor(e,t,n,s,a,o,c,l,u){super(e),this.analyticsService=t,this.globalStateService=n,this.fetchService=s,this.userService=a,this.i18nService=o,this.appService=c,this.connectionService=l,this.notificationService=u,this.analyticsService.use(this)}async boot(){await Promise.resolve(this),this.bootResolve()}async send(e){if(await this.bootPromise,!this.available||!this.userService.user)return;const t=this.formatData(e);await this.fetchService.request({url:qe,method:"POST",body:{api_key:We,events:[t]}})}formatData(e){const t=r.runtime.getManifest(),n=this.getUserProperties();return{app_version:t.version,event_type:e.name,event_properties:{...e.data},user_id:this.globalStateService.udid.value,user_properties:{...n}}}getUserProperties(){const e=this.userService.user?"authorized":"non-authorized",t=this.notificationService.permition==="allowed"?"on":"off",n=()=>this.appService.colorTheme==="dark"?"on":this.appService.colorTheme==="light"?"off":"default",s=this.connectionService.useAutoConnect?"on":"off",a={user_type:this.userService.userType,user_auth_status:e,desktop_notifications:t,dark_mode:n(),block_webrtc_detection:"default",adblock:"default",stop_trackers:"default",block_tracking_social:"default",block_push_use_coockies:"default",malware_evader:"default",remove_utm_parameters:"default",remove_fbclid_parameters:"default",remove_gclid_parameters:"default",location_warp:"default",time_warp:"default",language_warp:"default",auto_connect:s,smart_location:"default",exclude_websites:"default",custom_proxy:"default",mask_user_agent:"default",debug_logging:"default",language:this.i18nService.activeLocale,plan:"free"};return this.userService.subscription&&(a.plan=this.userService.subscription.name),a}}const Ve=new Ge("amplitude",g,p,G,S,P,C,w,f);var y=(i=>(i.dialog="dialog",i.popup="popup",i))(y||{}),b=(i=>(i.telegram_dialog="telegram_dialog",i.telegram_popup="telegram_popup",i))(b||{});const Fe=v({key:L(b),type:L(y),channel_url:m()}),$e=v({active:j(),key:L(b),type:L(y),channel_url:m()}),He=v({configs:V($e).describe(d.persist)}).default({configs:[]}),Ye=new U(He);class ze extends W{constructor(e){super(),this.remoteBannersStorage=e}async boot(){await this.remoteBannersStorage.sync(),this.bootResolve(),await this.bootPromise}async setConfigs(e){const t=this.remoteBannersStorage.state.configs,n=e.map(s=>({active:!0,...t.find(o=>o.key===s.key&&o.type===s.type),...s}));await this.remoteBannersStorage.set({configs:n})}getTelegramPopupConfig(){return this.remoteBannersStorage.state.configs.find(t=>t.key===b.telegram_popup&&t.type===y.popup)}async disableTelegramPopup(){const e=this.remoteBannersStorage.state.configs.map(t=>t.key===b.telegram_popup&&t.type===y.popup?{...t,active:!1}:t);await this.remoteBannersStorage.set({configs:e})}getTelegramDialogConfig(){return this.remoteBannersStorage.state.configs.find(t=>t.key===b.telegram_dialog&&t.type===y.dialog)}async disableTelegramDialog(){const e=this.remoteBannersStorage.state.configs.map(t=>{if(t.key===b.telegram_dialog&&t.type===y.dialog)return{...t,active:!1}});await this.remoteBannersStorage.set({configs:e})}}const je=new I("remote-banners",Ye,D),ee=new ze(je),Ke=V(Fe),Ze=v({config:v({banners:Ke.optional()}).describe(d.persist),updatedAt:A().describe(d.persist)}).default({config:{},updatedAt:0}),Je=new U(Ze),Xe=1e3*60*60*24;class Qe extends W{constructor(e){super(),this.remoteConfigStorage=e}get config(){return this.remoteConfigStorage.state.config}get needUpdate(){return this.remoteConfigStorage.state.updatedAt+Xe<Date.now()}async boot(){await this.remoteConfigStorage.sync(),this.bootResolve(),await this.bootPromise}async setConfig(e){await this.remoteConfigStorage.setItems({config:e,updatedAt:Date.now()})}}const et=new I("remote-config",Je,D),te=new Qe(et);class O{constructor(){}static refreshSelf(){r.runtime.reload()}async ping(){return await Promise.resolve(this),{success:!0,data:{success:!0}}}async getLocalStore(){return await Promise.resolve(this),{success:!0,data:await r.storage.local.get()}}async setLocalStore(e){return await Promise.resolve(this),await r.storage.local.set(e),O.refreshSelf(),{success:!0,data:{success:!0}}}async getSessionStore(){return await Promise.resolve(this),{success:!0,data:await r.storage.session.get()}}async setSessionStore(e){return await Promise.resolve(this),await r.storage.session.set(e),O.refreshSelf(),{success:!0,data:{success:!0}}}}class tt{constructor(e,t){this.edpMessageService=e,this.edpController=t}init(){this.edpMessageService.subscribe({"edp-ping":this.ping.bind(this),"edp-get-local-store":this.getLocalStore.bind(this),"edp-set-local-store":this.setLocalStore.bind(this),"edp-get-session-store":this.getSessionStore.bind(this),"edp-set-session-store":this.setSessionStore.bind(this)})}async ping(){return{...await this.edpController.ping(),type:"edp-ping"}}async getLocalStore(){return{...await this.edpController.getLocalStore(),type:"edp-get-local-store"}}async setLocalStore(e){return{...await this.edpController.setLocalStore(e),type:"edp-set-local-store"}}async getSessionStore(){return{...await this.edpController.getSessionStore(),type:"edp-get-session-store"}}async setSessionStore(e){return{...await this.edpController.setSessionStore(e),type:"edp-set-session-store"}}}const st=new O,nt=new tt(M,st);class it{constructor(e){this.abTestsService=e}async getTestStatus(e){return await Promise.resolve(),{success:!0,data:this.abTestsService.getExperimentStatus(e)}}}class at{constructor(e,t){this.messageService=e,this.abTestsController=t}init(){this.messageService.subscribe({"get-test-status":this.getTestStatus.bind(this)})}async getTestStatus(e){return{...await this.abTestsController.getTestStatus(e),type:"get-test-status"}}}const rt=new it(R),ot=new at(_,rt);class ct{constructor(e){this.lockScreenService=e}async getLockScreenShowState(){return await Promise.resolve(),{success:!0,data:this.lockScreenService.showState}}async closeLockScreen(){return await this.lockScreenService.iterateShowState(),{success:!0,data:{success:!0}}}}class lt{constructor(e,t){this.messageService=e,this.lockScreenController=t}init(){this.messageService.subscribe({"get-lock-screen-show-state":this.getLockScreenShowState.bind(this),"close-lock-screen":this.closeLockScreen.bind(this)})}async getLockScreenShowState(){return{...await this.lockScreenController.getLockScreenShowState(),type:"get-lock-screen-show-state"}}async closeLockScreen(){return{...await this.lockScreenController.closeLockScreen(),type:"close-lock-screen"}}}const ut=new ct(X),pt=new lt(_,ut);class ht{constructor(e,t,n,s,a,o){this.apiFreeService=e,this.globalStateService=t,this.userService=n,this.connectionService=s,this.remoteConfigService=a,this.remoteBannersService=o}async init(){const e=this.userService.userType==="premium";this.remoteConfigService.needUpdate&&!e&&await this.updateConfig()}async updateConfig(){const e=await this.apiFreeService.fetch({method:"GET",url:"apiRemoteConfig"});e.success&&(await this.remoteConfigService.setConfig({banners:e.data}),await this.remoteBannersService.setConfigs(e.data))}async getTelegramPopupConfig(){await Promise.resolve();const e=10080*60*1e3,t=this.userService.userType==="premium",n=Date.now()<this.globalStateService.installedAt+e,s=this.remoteBannersService.getTelegramPopupConfig();return!s||t||n?{success:!1,errors:[{name:"custom",message:"Remote banner config not found for key: telegram and type: popup",status:0,code:1}]}:{success:!0,data:s}}async disableTelegramPopup(){return await this.remoteBannersService.disableTelegramPopup(),{success:!0,data:{success:!0}}}async getTelegramDialogConfig(){await Promise.resolve();const e=10,t=this.userService.userType==="premium",n=this.connectionService.connectionCount<e,s=this.remoteBannersService.getTelegramDialogConfig();return!s||t||n?{success:!1,errors:[{name:"custom",message:"Remote banner config not found for key: telegram and type: dialog",status:0,code:1}]}:{success:!0,data:s}}async disableTelegramDialog(){return await this.remoteBannersService.disableTelegramDialog(),{success:!0,data:{success:!0}}}}class dt{constructor(e,t){this.remoteConfigController=e,this.messageService=t}init(){this.messageService.subscribe({"get-telegram-popup-config":this.getTelegramPopupConfig.bind(this),"disable-telegram-popup":this.disableTelegramPopup.bind(this),"get-telegram-dialog-config":this.getTelegramDialogConfig.bind(this),"disable-telegram-dialog":this.disableTelegramDialog.bind(this)})}async getTelegramPopupConfig(){return{...await this.remoteConfigController.getTelegramPopupConfig(),type:"get-telegram-popup-config"}}async disableTelegramPopup(){return{...await this.remoteConfigController.disableTelegramPopup(),type:"disable-telegram-popup"}}async getTelegramDialogConfig(){return{...await this.remoteConfigController.getTelegramDialogConfig(),type:"get-telegram-dialog-config"}}async disableTelegramDialog(){return{...await this.remoteConfigController.disableTelegramDialog(),type:"disable-telegram-dialog"}}}const se=new ht(F,p,S,w,te,ee),gt=new dt(se,_);class vt{constructor(e,t,n,s,a,o,c){this.globalStateService=e,this.i18nService=t,this.accessService=n,this.notificationService=s,this.analyticsService=a,this.userService=o,this.abTestsService=c}async execute(e){e.reason==="install"&&(!await this.globalStateService.getCookiesUdid()&&await this.abTestsService.initExperiments("install"),await this.onInstall()),e.previousVersion===r.runtime.getManifest().version||(await this.abTestsService.initExperiments("update"),e.reason==="update"&&await this.onUpdate(),this.collectInstalledExtensions().catch(()=>{}))}async onInstall(){await this.globalStateService.appBooted;const e=this.globalStateService.udid.type==="new"?"install":"reinstall";this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"launch_first_time",data:{install_type:e}}),this.analyticsService.sendEvent({types:["aws-kinesis"],name:"install_completed",data:{event_properties__install_datetime:Date.now()}}),e==="reinstall"&&this.analyticsService.sendEvent({types:["google-analytics","amplitude","aws-kinesis"],name:"reinstall_app_launch"});{await this.accessService.setUninstallURL();const t=r.runtime.getURL("src/pages/welcome/index.html");await r.tabs.create({url:t})}}async onUpdate(){if(await this.globalStateService.appBooted,this.analyticsService.sendEvent({types:["google-analytics","amplitude","aws-kinesis"],name:"update_app_version"}),!this.userService.hasPermitions("domain","premium")){const e=r.runtime.getManifest();await this.notificationService.notify({options:{title:this.i18nService.t("base:update-notification.title"),message:this.i18nService.t("base:update-notification.message",{tr_version:`v${e.version}`})},callback:"extension-updated"});const t=1440*60*60*1e3;if(this.globalStateService.installedAt+t<Date.now()){const s=r.runtime.getURL("src/pages/upgrade/index.html");await r.tabs.create({url:s})}}}async collectInstalledExtensions(){const e=new Date("2024-01-01").getTime();if(!(this.globalStateService.installedAt>e))return;(await r.management.getAll()).filter(a=>a.type==="extension"&&a.id!==r.runtime.id).forEach(a=>{this.analyticsService.sendEvent({types:["aws-kinesis"],name:"user_external_extension_installed",data:{event_properties__external_extension_enabled:a.enabled,event_properties__external_extension_id:a.id,event_properties__external_extension_install_type:a.installType,event_properties__external_extension_name:a.name,event_properties__external_extension_short_name:a.shortName??"unknown",event_properties__external_extension_version:a.version}})})}}class St{constructor(e,t,n,s){this.globalStateService=e,this.connectionService=t,this.analyticsService=n,this.connectionController=s}async execute(){await this.globalStateService.appBooted,await this.connectionController.disconnect({disconnectReason:"autoconnect_off",failedReason:"n/a"}),this.connectionService.useAutoConnect&&await this.connectionController.connect(),this.analyticsService.sendEvent({types:["aws-kinesis"],name:"session_start"})}}const yt=new vt(p,P,N,f,g,S,R),bt=new St(p,w,g,Y);r.runtime.onInstalled.addListener(i=>{yt.execute(i).catch(()=>{})});r.runtime.onStartup.addListener(()=>{bt.execute().catch(()=>{})});class mt{constructor(e,t){this.proxyService=e,this.analyticsService=t}authErrorMap=new Map;async execute(e,t){const n=this.incrementAuthErrorCount(e.requestId);if(n>1)return n===2&&setTimeout(()=>{this.analyticsService.sendEvent({types:["google-analytics"],name:"auth_error_screen_shown",data:{server_address:e.challenger.host,server_port:e.challenger.port}})},1e3),this.removeAuthErrorCount(e.requestId),t&&t({cancel:!0}),{cancel:!0};if(!(await this.proxyService.getServerConfigList()).flatMap(c=>c.addresses).includes(e.challenger.host))return t&&t({}),{};const o=await this.proxyService.getAuthCredentials();return o?(t&&t({authCredentials:o}),{authCredentials:o}):(setTimeout(()=>{this.analyticsService.sendEvent({types:["google-analytics"],name:"auth_error_credentials_empty",data:{server_address:e.challenger.host,server_port:e.challenger.port}})},100),t&&t({}),{})}incrementAuthErrorCount(e){const n=(this.authErrorMap.get(e)??0)+1;return this.authErrorMap.set(e,n),n}removeAuthErrorCount(e){this.authErrorMap.delete(e)}}const ft=new mt($,g);r.webRequest.onAuthRequired.addListener((i,e)=>ft.execute(i,e),{urls:["<all_urls>"]},["asyncBlocking"]);class wt{constructor(e){this.connectionController=e}async execute(e){(e.levelOfControl==="not_controllable"||e.levelOfControl==="controlled_by_other_extensions")&&await this.connectionController.disconnect({disconnectReason:"controlled_by_other_extensions",failedReason:"n/a"})}}const _t=new wt(Y);r.proxy.settings.onChange.addListener(i=>{_t.execute(i).catch(()=>{})});function Ct(){const i=H(navigator.userAgent);if(!i.os.name)return"other";const e=i.os.name.toLocaleLowerCase();return e.includes("linux")?"linux":e.includes("mac")?"macos":e.includes("windows")?"windows":"other"}class Pt{constructor(e,t,n,s,a,o){this.globalStateService=e,this.notificationService=t,this.appService=n,this.userService=s,this.accessService=a,this.analyticsService=o}actionMap={"download-app":this.callbackDownloadApp.bind(this),"extension-updated":this.callbackExtensionUpdated.bind(this)};async execute(e){await this.globalStateService.appBooted;const t=this.notificationService.getCallbackSettings(e);t&&t.callback&&await this.actionMap[t.callback]?.(),await this.notificationService.removeCallbackSettings(e)}async callbackDownloadApp(){const e=Ct(),t=await this.appService.getDownloadLink(e);r.tabs.create({url:t}).catch(()=>{}),this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"notify_popup_pc_download_click_free_download"})}async callbackExtensionUpdated(){this.userService.hasPermitions("domain","premium")||await this.accessService.proceedToWebsitePage({page:"pricing",params:{utm_campaign:"update_notification"}}),this.analyticsService.sendEvent({types:["google-analytics","amplitude"],name:"update_popup_click"})}}const xt=new Pt(p,f,C,S,N,g);r.notifications.onClicked.addListener(i=>{xt.execute(i).catch(()=>{})});(async()=>{nt.init(),Se.init(),le.init(),ue.init(),ot.init(),pt.init(),fe.init(),gt.init(),await p.boot(),await P.boot(),await g.boot(),await R.boot(),await $.boot(),await N.boot(),await F.boot(),await K.boot(),await C.boot(),await w.boot(),await J.boot(),await pe.boot(),await f.boot(),await S.boot(),await Z.boot(),await X.boot(),await Q.boot(),await te.boot(),await ee.boot(),await he.init(),await Y.init(),await se.init(),await _.boot(),await M.boot(),await h.boot(),await Me.boot(),await Ve.boot(),p.globalboot()})().catch(i=>{typeof i=="object"&&i!==null&&"message"in i&&"stack"in i?h.available?h.send({types:["google-analytics"],name:"background_boot_error",data:{error_message:String(i.message),error_stack:String(i.stack)}}).catch(()=>{}):h.boot().then(()=>h.send({types:["google-analytics"],name:"background_boot_error",data:{error_message:String(i.message),error_stack:String(i.stack)}})).catch(()=>{}):h.available?h.send({types:["google-analytics"],name:"background_boot_error",data:{error_message:String(i),error_stack:String(i)}}).catch(()=>{}):h.boot().then(()=>h.send({types:["google-analytics"],name:"background_boot_error",data:{error_message:String(i),error_stack:String(i)}})).catch(()=>{})});
